<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewModels="clr-namespace:Lubrisense.ViewModels"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:inputLayout="clr-namespace:Syncfusion.Maui.Toolkit.TextInputLayout;assembly=Syncfusion.Maui.Toolkit"
             x:Class="Lubrisense.Views.DeviceConfigView"
             Title="Configuração"
             BackgroundColor="#F5F5F5"
             x:DataType="viewModels:DeviceConfigViewModel">

    <ContentPage.Resources>
        <ResourceDictionary>
            <toolkit:InvertedBoolConverter x:Key="InvertedBoolConverter" />

            <Color x:Key="PrimaryColor">#2196F3</Color>
            <Color x:Key="ActiveText">White</Color>
            <Color x:Key="InactiveText">#666666</Color>

            <Style x:Key="TabButtonStyle" TargetType="Button">
                <Setter Property="BackgroundColor" Value="Transparent" />
                <Setter Property="TextColor" Value="{StaticResource InactiveText}" />
                <Setter Property="BorderColor" Value="#CCCCCC" />
                <Setter Property="BorderWidth" Value="1" />
                <Setter Property="CornerRadius" Value="20" />
                <Setter Property="HeightRequest" Value="40" />
                <Setter Property="Margin" Value="5,0" />
                <Setter Property="Padding" Value="0" />
                <Setter Property="FontAttributes" Value="None" />
            </Style>
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Margin="15" Spacing="20" Padding="0,0,0,30">

            <!-- 1. BARRA DE STATUS -->
            <Frame BackgroundColor="{Binding CorStatus}" Padding="10" CornerRadius="8" HasShadow="False" BorderColor="Transparent">
                <HorizontalStackLayout HorizontalOptions="Center" Spacing="10">
                    <ActivityIndicator IsRunning="{Binding IsBusy}" IsVisible="{Binding IsBusy}" Color="White" HeightRequest="20" WidthRequest="20"/>
                    <Label Text="{Binding StatusConexao}" TextColor="White" FontAttributes="Bold" VerticalOptions="Center"/>
                </HorizontalStackLayout>
            </Frame>

            <!-- 2. DADOS DE CADASTRO -->
            <Frame BackgroundColor="White" CornerRadius="10" HasShadow="True" BorderColor="Transparent" Padding="20">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Identificação" TextColor="#333333" FontSize="16" FontAttributes="Bold"/>

                    <inputLayout:SfTextInputLayout Hint="Equipamento" ContainerType="Outlined" ErrorText="Obrigatório" HasError="{Binding ErroEquipamento}">
                        <Entry Text="{Binding TextoEquipamento, Mode=TwoWay}"/>
                    </inputLayout:SfTextInputLayout>

                    <inputLayout:SfTextInputLayout Hint="Setor" ContainerType="Outlined" ErrorText="Obrigatório" HasError="{Binding ErroSetor}">
                        <Entry Text="{Binding TextoSetor, Mode=TwoWay}"/>
                    </inputLayout:SfTextInputLayout>

                    <!-- TAG e Lubrificante em linhas separadas -->
                    <inputLayout:SfTextInputLayout Hint="TAG" ContainerType="Outlined">
                        <Entry Text="{Binding TextoTag, Mode=TwoWay}"/>
                    </inputLayout:SfTextInputLayout>

                    <inputLayout:SfTextInputLayout Hint="Lubrificante" ContainerType="Outlined">
                        <Entry Text="{Binding TextoLubrificante, Mode=TwoWay}"/>
                    </inputLayout:SfTextInputLayout>

                </VerticalStackLayout>
            </Frame>

            <!-- 3. CARTÃO DE PARÂMETROS -->
            <Frame BackgroundColor="White" CornerRadius="10" HasShadow="True" BorderColor="Transparent" Padding="20">
                <VerticalStackLayout Spacing="20">

                    <!-- SELETOR DE MODO -->
                    <Grid ColumnDefinitions="*,*" Margin="0,0,0,10">
                        <Button Grid.Column="0" Text="Básico" Command="{Binding OnChangeBasicClickedCommand}" Style="{StaticResource TabButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button" Binding="{Binding ConfigIsAdvanced}" Value="False">
                                    <Setter Property="BackgroundColor" Value="{StaticResource PrimaryColor}" />
                                    <Setter Property="TextColor" Value="{StaticResource ActiveText}" />
                                    <Setter Property="BorderColor" Value="{StaticResource PrimaryColor}" />
                                    <Setter Property="FontAttributes" Value="Bold" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                        <Button Grid.Column="1" Text="Avançado" Command="{Binding OnChangeAdvanceClickedCommand}" Style="{StaticResource TabButtonStyle}">
                            <Button.Triggers>
                                <DataTrigger TargetType="Button" Binding="{Binding ConfigIsAdvanced}" Value="True">
                                    <Setter Property="BackgroundColor" Value="{StaticResource PrimaryColor}" />
                                    <Setter Property="TextColor" Value="{StaticResource ActiveText}" />
                                    <Setter Property="BorderColor" Value="{StaticResource PrimaryColor}" />
                                    <Setter Property="FontAttributes" Value="Bold" />
                                </DataTrigger>
                            </Button.Triggers>
                        </Button>
                    </Grid>

                    <Label Text="{Binding ConfigIsAdvanced, Converter={toolkit:BoolToObjectConverter TrueObject='Modo Avançado', FalseObject='Modo Básico'}}"
                           TextColor="#333333" FontSize="18" FontAttributes="Bold" HorizontalOptions="Center" />

                    <Label Text="{Binding ConfigIsAdvanced, Converter={toolkit:BoolToObjectConverter TrueObject='Dose fixa a cada disparo.', FalseObject='Cálculo de dose baseado na duração total.'}}"
                           TextColor="#777777" FontSize="12" HorizontalOptions="Center" Margin="0,-15,0,10"/>

                    <!-- CAMPOS COMUNS -->
                    <inputLayout:SfTextInputLayout Hint="Volume do Lubrificante (g)" ContainerType="Outlined" HasError="{Binding ErroVolume}">
                        <Entry Text="{Binding Volume, Mode=TwoWay}" Keyboard="Numeric"/>
                    </inputLayout:SfTextInputLayout>

                    <!-- MODO BÁSICO -->
                    <VerticalStackLayout Spacing="20" IsVisible="{Binding ConfigIsAdvanced, Converter={StaticResource InvertedBoolConverter}}">
                        <Grid ColumnDefinitions="*, Auto, *">
                            <inputLayout:SfTextInputLayout Grid.Column="0" Hint="Duração Total" ContainerType="Outlined" HasError="{Binding ErroDuracaoTotal}">
                                <Entry Text="{Binding DuracaoTotal, Mode=TwoWay}" Keyboard="Numeric" HorizontalTextAlignment="Center"/>
                            </inputLayout:SfTextInputLayout>

                            <inputLayout:SfTextInputLayout Grid.Column="2" Hint="Unidade" ContainerType="Outlined" HasError="{Binding ErroTipoDuracao}">
                                <Picker SelectedItem="{Binding TipoDuracao}" Title="Selecione...">
                                    <Picker.ItemsSource>
                                        <x:Array Type="{x:Type x:String}">
                                            <x:String>Hora</x:String>
                                            <x:String>Dia</x:String>
                                            <x:String>Mês</x:String>
                                        </x:Array>
                                    </Picker.ItemsSource>
                                </Picker>
                            </inputLayout:SfTextInputLayout>
                        </Grid>
                    </VerticalStackLayout>

                    <!-- MODO AVANÇADO (Sem campos extras, usa apenas Volume e Frequência) -->

                    <!-- FREQUÊNCIA (GATILHO) - Agora integrado ao fluxo -->
                    <Grid ColumnDefinitions="*, Auto, *">
                        <inputLayout:SfTextInputLayout Grid.Column="0" Hint="A cada..." ContainerType="Outlined" HasError="{Binding ErroFrequencia}">
                            <Entry Text="{Binding Frequencia, Mode=TwoWay}" Keyboard="Numeric" HorizontalTextAlignment="Center"/>
                        </inputLayout:SfTextInputLayout>
                        <inputLayout:SfTextInputLayout Grid.Column="2" Hint="Unidade" ContainerType="Outlined" HasError="{Binding ErroTipoFrequencia}">
                            <Picker SelectedItem="{Binding TipoFrequencia}" Title="Selecione...">
                                <Picker.ItemsSource>
                                    <x:Array Type="{x:Type x:String}">
                                        <x:String>Hora</x:String>
                                        <x:String>Dia</x:String>
                                        <x:String>Mês</x:String>
                                    </x:Array>
                                </Picker.ItemsSource>
                            </Picker>
                        </inputLayout:SfTextInputLayout>
                    </Grid>
                </VerticalStackLayout>
            </Frame>

            <Button Text="SALVAR CONFIGURAÇÃO" Command="{Binding SalvarCommand}" BackgroundColor="#4CAF50" TextColor="White" FontAttributes="Bold" CornerRadius="25" HeightRequest="50" Margin="0,10,0,0"/>

            <Button Text="Excluir Dispositivo" Command="{Binding ExcluirCommand}" BackgroundColor="Transparent" TextColor="#D32F2F" BorderColor="#D32F2F" BorderWidth="1" Margin="0,10,0,0"/>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>